<html>
    <head>
        <meta charset="utf-8">
        <script src="https://d3js.org/d3.v5.js"></script>
        <script src="image_dictionary.js"></script>
        <title>CPSC 583 Project</title>
        <style>
            p {
                font-size: 10px;
                margin: 2px;
            }
            body{
                background: #19181a;
                color:#f4f4f4;
                
            }
            #top,#about{
                margin: auto;
                width: 70%;
                padding: 10px;
            }
            img{
                filter:invert(1);
            }
            .label {
                font-weight: bold;
            }
            button {
                font-family: Times;
                background-color: #19181a;
                border: none;
                color: white;
                cursor: pointer;
                margin-bottom: 15px;
            }
            .selected_button {
                background-color: #333;
            }
            .selected {
                opacity: 1;
            }
            rect {
                opacity: 0.2;
            }
            line {
                opacity: 0.2;
            }
            svg {
                background-color: #111;
            }
        </style>
    </head>
    <body>
        <div id="top">
            <h1 id="pageTitle">An interactive vizualization of micronutrient content in fast food items</h1>
            Based on the food dataset, this vizualization highlights four key macro nutrients found in fast food items 
            from different chains
            
        </div>
        <div>
            <br>
        </div>
        <div id="visualization"></div>

        <script>
        const margin = {top: 10, right: 10, bottom: 10, left: 25}
            const width = 1200;
            const height = 400;
            loaded_data = {}

            // add the base svg
            let svg = d3.select("#visualization")
                        .append("svg")
                            .style("width", "47%")
                            .style("margin-left", "2%")
                            .style("margin-right", "1%")
                            .style("margin-bottom", "15px")
                            .attr("height", height + margin.top + margin.bottom)
                            .call(
                                d3.zoom().on("zoom", function () {
                                svg.attr("transform", d3.event.transform)
                            }))
                        .append("g")
                        .style("width", "45%")

            let svg2 = d3.select("#visualization")
                    .append("svg")
                        .attr("id", "right_svg")
                        .style("width", "47%")
                        .style("margin-right", "2%")
                        .style("margin-left", "1%")
                        .style("margin-bottom", "15px")
                        .attr("height", height + margin.top + margin.bottom)
                        .call(
                            d3.zoom().on("zoom", function () {
                            svg2.attr("transform", d3.event.transform)
                        }))
                    .append("g")
                    .style("width", "45%")

            d3.json("./data.json")
                .then(function(data) {
                    loaded_data = data;
                    for(var resaurant in loaded_data){
                        for (var item in loaded_data[resaurant]){
                            loaded_data[resaurant][item]['fill']=randomColor();
                        }
                    }
                    change_subset("McDonald's", MCDs_Multi, "left");
                    change_subset("Burger King", BKs_Multi, "right");
                });
            
            function display(item, bars, multiplier, side){
                let macros = ["fat", "carbs", "protein", "sodium"]
                last_x = -1
                last_y = -1
                if (side === "left"){
                    obj = svg;
                    other_multiplier = 1
                } else {
                    obj = svg2;
                    other_multiplier = -1
                }

                for(let i = 0; i < macros.length; i++){
                    bar_length = parseFloat(item[macros[i]])*multiplier[macros[i]]
                    obj.data([item])
                        .append("rect")
                            .attr("class", "_" + item["id"] + " data" + side)
                            .attr("x", function(){
                                if(other_multiplier === -1){
                                    return bars[macros[i]] - bar_length
                                } else {
                                    return bars[macros[i]]
                                }
                            })
                            .attr("y", 100*i + 40)
                            .attr("width", bar_length)
                            .attr("height", 50)
                            .attr("fill", item["fill"])
                            .on("click", function(d){
                                highlight(d["id"], true)
                            })
                    bars[macros[i]] += (bar_length + 0.5)*other_multiplier

                    let new_x = bars[macros[i]] - (bar_length/2)*other_multiplier;
                    let new_y = 100*i + 40;

                    if(last_x != -1){
                        // draw line from last x/y to middle of this rectangle
                        obj.append("line")
                            .attr("class", "_" + item["id"] + " data" + side)
                            .attr("x1", last_x)
                            .attr("x2", new_x)
                            .attr("y1", last_y)
                            .attr("y2", new_y)
                            .attr("stroke", item["fill"])
                    }
                    last_x = new_x;
                    last_y = new_y + 50;
                }
                // remove old labels
                d3.selectAll(".label" + side).remove()
                // need to make sodium label scale dynamically
                let macros2 = ["Fat(g)", "Carbs(g)", "Protein(g)", "Sodium(" + 1/multiplier["sodium"] + "mg)"]
                for(let i = 0; i < macros2.length; i++){
                    obj.append("text")
                        .attr("class", "label" + side)
                        .attr("x", function(){
                            if(side == "left"){
                                return bars[macros[i]] + 10;
                            } else {
                                return bars[macros[i]] - macros2[i].length*9;
                            }
                        })
                        .attr("y", 100*i + 70)
                        .attr("fill", "white")
                        .html(macros2[i])
                }
            }

            function highlight_txt(id, recurse){
               d3.selectAll(".txt")
                    .style("background-color", function(d){
                        if(d["id"] == id){
                            return "grey";
                        } else {
                            return "white";
                        }
                    })
                if(recurse){
                    highlight(id, false)
                }
            }

            function highlight(id, recurse){
                d3.selectAll("._" + id)
                    .classed("selected", function(dat){
                        if(dat["id"] == id && this.classList.contains("selected")){
                            return false;
                        } else if(dat["id"] == id || this.classList.contains("selected")){
                            return true;
                        } else {
                            return false;
                        }
                    })
                if(recurse){
                    highlight_txt(id, false)
                }
            }
            
            function change_subset(restaurant, multiplier, side){
                // change button color by giving it selected_button class
                d3.selectAll("button")
                    .classed("selected_button", function(){
                        if (this.innerHTML == restaurant){
                            return true
                        } else {
                            return false
                        }
                    })
                let bars = {}
                right_width = window.innerWidth * 0.46
                if(side == "left") {
                    bars = {"fat": 0, "carbs": 0, "protein": 0, "water": 0, "sodium": 0}
                    d3.select("#title-left").remove()
                    svg.append("text")
                        .attr("id", "title-left")
                        .html(restaurant)
                        .attr("x", right_width - 100)
                        .attr("y", 20)
                        .attr("fill", "white")
                } else {
                    bars = {"fat": right_width, "carbs": right_width, "protein": right_width, "water": right_width, "sodium": right_width}
                    d3.select("#title-right").remove()
                    svg2.append("text")
                        .attr("id", "title-right")
                        .html(restaurant)
                        .attr("x", 20)
                        .attr("y", 20)
                        .attr("fill", "white")
                }
                d3.selectAll(".data" + side).remove();
                for(let item of loaded_data[restaurant]){
                    display(item, bars, multiplier, side);
                }

                d3.selectAll(".img").remove()
                let imgs = d3.select("#text_section")

                var gridCols=23;
                imgs.append("div")
                imgs.append("tr")

                var currentCount=0;
                for(let item of loaded_data[restaurant]){
                    if (currentCount==gridCols){
                         currentCount=0;
                         imgs.append("tr");
                     }
                    currentCount=currentCount+1;
                    imgs
                        .append("td")
                        .data([item])
                            .attr("class", "img")
                            .on("click", function(){highlight_txt(item["id"], true)})
                            //.html(`<img src="./images/${restaurant}/${loaded_data[restaurant].indexOf(item)}.jpeg"style="width:50px;height:60px;">`)
                            .html(`<img src="./images/test/${dict[item["name"]]}"style="width:50px;height:60px;">`)
                }

            }
            const MCDs_Multi = {'fat':.3,'carbs':.3,'protein':.3,'water':.3, 'sodium':0.01};
            const BKs_Multi = {'fat':1,'carbs':1,'protein':1,'water':1, 'sodium':0.01};
            const WDs_Multi = {'fat':2,'carbs':2,'protein':2,'water':2, 'sodium':0.01};
            const PH_Multi  = {'fat':1,'carbs':1,'protein':1,'water':1, 'sodium':0.01};
            const DPs_Multi = {'fat':1.5,'carbs':1.5,'protein':1.5,'water':1.5, 'sodium':0.01};
            const KFC_Multi = {'fat':1,'carbs':1,'protein':1,'water':1, 'sodium':0.01};
            const TBs_Multi = {'fat':2,'carbs':2,'protein':2,'water':2, 'sodium':0.01};
            const Pop_Multi = {'fat':2,'carbs':2,'protein':2,'water':2, 'sodium':0.01};

           
            var randomColor = (function(){
            var golden_ratio_conjugate = 0.618033988749895;
            var h = Math.random();

            var hslToRgb = function (h, s, l){
                var r, g, b;

                if(s == 0){
                    r = g = b = l; // achromatic
                }else{
                    function hue2rgb(p, q, t){
                        if(t < 0) t += 1;
                        if(t > 1) t -= 1;
                        if(t < 1/6) return p + (q - p) * 6 * t;
                        if(t < 1/2) return q;
                        if(t < 2/3) return p + (q - p) * (2/3 - t) * 6;
                        return p;
                    }

                    var q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                    var p = 2 * l - q;
                    r = hue2rgb(p, q, h + 1/3);
                    g = hue2rgb(p, q, h);
                    b = hue2rgb(p, q, h - 1/3);
                }

                return '#'+Math.round(r * 255).toString(16)+Math.round(g * 255).toString(16)+Math.round(b * 255).toString(16);
            };
            
            return function(){
                h += golden_ratio_conjugate;
                h %= 1;
                return hslToRgb(h, 0.5, 0.60);
            };
            })();
            
        </script>
        <div style="margin-right: 2%; width: 45%; display: inline;">
        <button onclick="change_subset('McDonald\'s', MCDs_Multi, 'left')" type="button">McDonald's</button>
        <button onclick="change_subset('Burger King', BKs_Multi, 'left')" type="button">Burger King</button>
        <button onclick="change_subset('Wendy\'s', WDs_Multi, 'left')" type="button">Wendy's</button>
        <button onclick="change_subset('Pizza Hut', PH_Multi, 'left')" type="button">Pizza Hut</button>
        <button onclick="change_subset('Dominos', DPs_Multi, 'left')" type="button">Dominos</button>
        <button onclick="change_subset('KFC', KFC_Multi, 'left')" type="button">KFC</button>
        <button onclick="change_subset('Taco Bell', TBs_Multi, 'left')" type="button">Taco Bell</button>
        <button onclick="change_subset('Popeyes', Pop_Multi, 'left')" type="button">Popeyes</button>
        </div>

        <div style="margin-left: 2%; width 45%; display: inline; float: right;">
        <button onclick="change_subset('McDonald\'s', MCDs_Multi, 'right')" type="button">McDonald's</button>
        <button onclick="change_subset('Burger King', BKs_Multi, 'right')" type="button">Burger King</button>
        <button onclick="change_subset('Wendy\'s', WDs_Multi, 'right')" type="button">Wendy's</button>
        <button onclick="change_subset('Pizza Hut', PH_Multi, 'right')" type="button">Pizza Hut</button>
        <button onclick="change_subset('Dominos', DPs_Multi, 'right')" type="button">Dominos</button>
        <button onclick="change_subset('KFC', KFC_Multi, 'right')" type="button">KFC</button>
        <button onclick="change_subset('Taco Bell', TBs_Multi, 'right')" type="button">Taco Bell</button>
        <button onclick="change_subset('Popeyes', Pop_Multi, 'right')" type="button">Popeyes</button>
        </div>
   
    <div id="text_section"></div>
    <div id="about">
        <h2>About</h2>
        <br>
        As univeristy students, fast food is a staple item in our diet, but we never truly 
        know all the macronutrients that we put into our body. We designed this vizualization 
        in order to help us see what we truly put into our body. 
        
        <h4>Insight</h4>
        

       
    </div>
</body>
</html>